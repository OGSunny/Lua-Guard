<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Lua Guard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 50px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 1.5rem; font-weight: bold; }
        .logo a { color: #fff; text-decoration: none; }
        .logo span { color: #5865F2; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-links a { color: #888; text-decoration: none; }
        .nav-links a:hover, .nav-links a.active { color: #fff; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 8px 15px;
            border-radius: 50px;
        }
        .user-info img { width: 32px; height: 32px; border-radius: 50%; }
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        .header { margin-bottom: 40px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .header p { color: #888; }
        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: #5865F2; color: #fff; }
        .btn-primary:hover { background: #4752C4; }
        .btn-success { background: #57F287; color: #000; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-header h2 { font-size: 1.3rem; }
        .key-display {
            background: #0a0a0f;
            border: 2px solid #5865F2;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .key-display code {
            font-family: monospace;
            font-size: 1.3rem;
            color: #00D4AA;
            letter-spacing: 2px;
        }
        .key-info { display: flex; gap: 30px; flex-wrap: wrap; }
        .key-info-item label { color: #888; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        .key-info-item span { font-weight: 600; }
        .status-active { color: #57F287; }
        .status-expired { color: #ED4245; }
        .no-key {
            text-align: center;
            padding: 50px;
        }
        .no-key h3 { margin-bottom: 10px; color: #888; }
        .no-key p { color: #666; margin-bottom: 20px; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .stat-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(88,101,242,0.1);
            border-radius: 10px;
            font-size: 1.5rem;
        }
        .stat-info h3 { font-size: 1.5rem; }
        .stat-info p { color: #888; font-size: 0.9rem; }
        .script-box {
            background: #0a0a0f;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
        }
        .script-box code {
            color: #00D4AA;
            font-family: monospace;
            word-break: break-all;
        }
        .script-box button {
            margin-top: 10px;
            background: #333;
            border: none;
            color: #fff;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .script-box button:hover { background: #444; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { color: #888; font-weight: 600; }
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-success { background: rgba(87,242,135,0.1); color: #57F287; }
        .badge-danger { background: rgba(237,66,69,0.1); color: #ED4245; }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #12121a;
            border: 1px solid #57F287;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
        }
        .toast.show { display: flex; align-items: center; gap: 10px; }
        .loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading.hidden { display: none; }
        .generate-section { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .hwid-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            background: #12121a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-family: monospace;
        }
        @media (max-width: 768px) {
            .navbar { padding: 15px 20px; flex-wrap: wrap; gap: 15px; }
            .key-display { flex-direction: column; gap: 15px; text-align: center; }
            .key-display code { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 15px;">‚è≥</div>
            <p>Loading...</p>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo"><a href="/">üõ°Ô∏è <span>Lua</span> Guard</a></div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/dashboard.html" class="active">Dashboard</a>
            <a href="/admin.html">Admin</a>
        </div>
        <div class="user-info" id="user-info">
            <span id="username">Guest</span>
            <a href="/api?route=auth/discord" class="btn btn-primary" id="login-btn">Login</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üëã Welcome to Dashboard</h1>
            <p>Manage your keys and access your scripts</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üîë</div>
                <div class="stat-info">
                    <h3 id="my-keys-count">0</h3>
                    <p>Your Keys</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <h3 id="active-keys-count">0</h3>
                    <p>Active Keys</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-info">
                    <h3 id="member-since">-</h3>
                    <p>Member Since</p>
                </div>
            </div>
        </div>

        <!-- Generate Key -->
        <div class="card">
            <div class="card-header">
                <h2>üîë Generate New Key</h2>
            </div>
            <div class="generate-section">
                <input type="text" class="hwid-input" id="hwid-input" placeholder="Enter your HWID (get from script)">
                <button class="btn btn-primary" onclick="generateKey()">‚ö° Generate Key</button>
            </div>
            <p style="color: #888; margin-top: 15px; font-size: 0.9rem;">
                üí° Run the loader script in Roblox to get your HWID, or use: <code>TEST-HWID-12345</code> for testing
            </p>
        </div>

        <!-- Active Key -->
        <div class="card" id="active-key-card" style="display: none;">
            <div class="card-header">
                <h2>üé´ Your Active Key</h2>
                <span class="badge badge-success" id="key-status">Active</span>
            </div>
            <div class="key-display">
                <code id="current-key">LUAGUARD-XXXX-XXXX-XXXX-XXXX</code>
                <button class="btn btn-secondary" onclick="copyKey()">üìã Copy</button>
            </div>
            <div class="key-info">
                <div class="key-info-item">
                    <label>Expires In</label>
                    <span id="key-expires" class="status-active">24h 0m</span>
                </div>
                <div class="key-info-item">
                    <label>Created</label>
                    <span id="key-created">-</span>
                </div>
                <div class="key-info-item">
                    <label>Uses</label>
                    <span id="key-uses">0</span>
                </div>
            </div>
        </div>

        <!-- No Key -->
        <div class="card" id="no-key-card">
            <div class="no-key">
                <h3>üîë No Active Key</h3>
                <p>Generate a new key above to get started</p>
            </div>
        </div>

        <!-- Script Loader -->
        <div class="card">
            <div class="card-header">
                <h2>üìú Script Loader</h2>
            </div>
            <p style="color: #888; margin-bottom: 15px;">Copy this script and run it in your Roblox executor:</p>
            <div class="script-box">
                <code id="loader-script">loadstring(game:HttpGet("https://lua-guard-test.vercel.app/lua/loader.lua"))()</code>
                <br>
                <button onclick="copyScript()">üìã Copy Script</button>
            </div>
        </div>

        <!-- Key History -->
        <div class="card">
            <div class="card-header">
                <h2>üìã Key History</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Created</th>
                        <th>Expires</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="keys-table">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #888;">No keys yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="toast" id="toast">
        <span>‚úÖ</span>
        <span id="toast-message">Copied!</span>
    </div>

    <script>
        const API = '/api';
        let currentHWID = localStorage.getItem('hwid') || '';
        
        document.getElementById('hwid-input').value = currentHWID;
        document.getElementById('loader-script').textContent = `loadstring(game:HttpGet("${window.location.origin}/lua/loader.lua"))()`;
        
        // Check URL params for new key
        const params = new URLSearchParams(window.location.search);
        if (params.get('key') && params.get('success')) {
            showToast('Key generated: ' + params.get('key'));
            window.history.replaceState({}, '', '/dashboard.html');
        }
        
        // Load data
        async function loadData() {
            hideLoading();
            
            // Check user
            try {
                const userRes = await fetch(API + '?route=auth/me');
                const userData = await userRes.json();
                if (userData.success) {
                    document.getElementById('username').textContent = userData.user.username;
                    document.getElementById('login-btn').style.display = 'none';
                }
            } catch (e) {}
            
            // Load keys if HWID exists
            if (currentHWID) {
                loadKeys();
            }
        }
        
        async function loadKeys() {
            try {
                const res = await fetch(API + '?route=keys/user&hwid=' + currentHWID);
                const data = await res.json();
                
                if (data.success && data.keys.length > 0) {
                    document.getElementById('my-keys-count').textContent = data.keys.length;
                    
                    const activeKeys = data.keys.filter(k => k.is_active);
                    document.getElementById('active-keys-count').textContent = activeKeys.length;
                    
                    if (activeKeys.length > 0) {
                        const key = activeKeys[0];
                        document.getElementById('active-key-card').style.display = 'block';
                        document.getElementById('no-key-card').style.display = 'none';
                        document.getElementById('current-key').textContent = key.key;
                        document.getElementById('key-expires').textContent = key.time_remaining;
                        document.getElementById('key-created').textContent = new Date(key.created_at).toLocaleDateString();
                        document.getElementById('key-uses').textContent = key.use_count;
                    }
                    
                    // Update table
                    const tbody = document.getElementById('keys-table');
                    tbody.innerHTML = data.keys.map(k => `
                        <tr>
                            <td><code>${k.key.substring(0, 20)}...</code></td>
                            <td>${new Date(k.created_at).toLocaleDateString()}</td>
                            <td>${k.time_remaining}</td>
                            <td><span class="badge ${k.is_active ? 'badge-success' : 'badge-danger'}">${k.is_active ? 'Active' : 'Expired'}</span></td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        async function generateKey() {
            const hwid = document.getElementById('hwid-input').value.trim();
            
            if (!hwid) {
                showToast('Please enter your HWID');
                return;
            }
            
            currentHWID = hwid;
            localStorage.setItem('hwid', hwid);
            
            showLoading();
            
            try {
                const res = await fetch(API + '?route=keys/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hwid: hwid })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    if (data.hasActiveKey) {
                        showToast('You already have an active key!');
                    } else {
                        showToast('Key generated: ' + data.key);
                    }
                    loadKeys();
                } else {
                    showToast(data.error || 'Failed to generate key');
                }
            } catch (e) {
                showToast('Error generating key');
            }
            
            hideLoading();
        }
        
        function copyKey() {
            const key = document.getElementById('current-key').textContent;
            navigator.clipboard.writeText(key);
            showToast('Key copied!');
        }
        
        function copyScript() {
            const script = document.getElementById('loader-script').textContent;
            navigator.clipboard.writeText(script);
            showToast('Script copied!');
        }
        
        function showToast(message) {
            document.getElementById('toast-message').textContent = message;
            document.getElementById('toast').classList.add('show');
            setTimeout(() => document.getElementById('toast').classList.remove('show'), 3000);
        }
        
        function showLoading() { document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        
        loadData();
    </script>
</body>
</html>
